name: delivery

on:
  workflow_dispatch:

jobs:
  version:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6

    - name: Setup uv and Python
      uses: astral-sh/setup-uv@v7
      with:
        version: latest

    - name: Bump Version
      run: |
        uv version --bump patch
        echo PROJECT_VERSION=$(uv run python -c "from importlib.metadata import version; print(version('iceberg-mcp-server'))") > $GITHUB_ENV

    - name: Update server.json
      run: jq --arg v "${{ env.PROJECT_VERSION }}" '.version = $v | .packages |= map(.version = $v)' server.json > server.tmp && mv server.tmp server.json

    - name: Commit Version
      uses: stefanzweifel/git-auto-commit-action@v7
      with:
        commit_message: "chore: bump version to v${{ env.PROJECT_VERSION }}"

  publish:
    runs-on: ubuntu-latest

    needs: version

    environment:
      name: pypi
      url: https://pypi.org/p/iceberg-mcp-server

    permissions:
      id-token: write
      contents: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        ref: ${{ github.ref }}

    - name: Setup uv and Python
      uses: astral-sh/setup-uv@v7
      with:
        version: latest

    - name: Build with uv
      run: |
        uv build
        echo PROJECT_VERSION=$(uv run python -c "from importlib.metadata import version; print(version('iceberg-mcp-server'))") > $GITHUB_ENV
        
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1

    - name: Install mcp-publisher
      run: curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher

    - name: Authenticate to MCP Registry
      run: ./mcp-publisher login github-oidc

    - name: Publish to MCP Registry
      run: ./mcp-publisher publish
        
    - name: Release Version
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "v${{ env.PROJECT_VERSION }}"
        generate_release_notes: true
        make_latest: true
        files: dist/iceberg_mcp_server-${{ env.PROJECT_VERSION }}-py3-none-any.whl
        body: |
          * View on PyPI at: https://pypi.org/project/iceberg-mcp-server/${{ env.PROJECT_VERSION }}/
          * Run `uvx iceberg-mcp-server@latest` to use with latest release, or `uvx iceberg-mcp-server@${{ env.PROJECT_VERSION }}` to use with this specific release.